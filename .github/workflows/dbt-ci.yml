name: dbt CI Pipeline

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  run-dbt-tests:
    runs-on: Windows 10

    env:
      DBT_PROFILES_DIR: ./ci_profiles  

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install dbt-core dbt-synapse

      - name: Create dbt profiles.yml
        run: |
          mkdir -p ci_profiles
          cat > ci_profiles/profiles.yml <<EOF
          empower_project:
            target: dev
            outputs:
              dev:
                type: synapse
                driver: "ODBC Driver 18 for SQL Server"
                server: "eb-outdoorlightingperspective-workspace.sql.azuresynapse.net"
                port: 1433
                database: "OLP"
                schema: "DBT_SL"
                encrypt: true
                trust_cert: true
                threads: 1
                authentication: "ActiveDirectoryServicePrincipal"
                client_id: "${{ secrets.AZURE_CLIENT_ID }}"
                client_secret: "${{ secrets.AZURE_CLIENT_SECRET }}"
                tenant_id: "${{ secrets.AZURE_TENANT_ID }}"
          EOF

      - name: Run dbt tests
        run: |
          dbt debug
          dbt deps
          dbt seed --full-refresh
          dbt run
          dbt test
